!function(e,r){if("object"==typeof exports&&"object"==typeof module)module.exports=r(require("long"),require("protobufjs/minimal"));else if("function"==typeof define&&define.amd)define(["long","protobufjs/minimal"],r);else{var n="object"==typeof exports?r(require("long"),require("protobufjs/minimal")):r(e.long,e["protobufjs/minimal"]);for(var t in n)("object"==typeof exports?exports:e)[t]=n[t]}}("undefined"!=typeof self?self:this,(function(e,r){return function(){"use strict";var n={1290:function(e,r,n){n.d(r,{RnN:function(){return i},v$W:function(){return t},zUi:function(){return o},zub:function(){return s}});var t="zc.crh.a.0",o="zc.hrh.smt.0",s="zc.hrh.smt.1",i="zc.hrh.grdbc"},4908:function(e,r,n){n.d(r,{Of:function(){return i},iJ:function(){return u},ns:function(){return c},pO:function(){return s}});var t=n(8627),o=n(5095),s={event:"/sdk/start_publish",error:{t:t.LLz,i:t.Q9p,u:t.xfZ,l:t.gSF,m:t.PA0,p:t.fzq,_:t.f43,v:t.qvY,k:t.S4u,O:t.SRE,j:t.Xxx,q:t.g9p,P:t.jZ$,S:t.$wo,D:t.SmZ,C:t.VU9,N:t.MrD,T:t.ZpF,R:t.iei,B:t.aa2,J:t.HCP,Z:t.dg1,U:t._68,F:t.kbF,W:t.kOd,A:t.WP4,$:t.JDv,K:t.Q3v,X:t.RBR,V:t.NCg,Y:t.xbZ,G:t.OdW},urls:o.yp,is_center:o.yS,server_url:o.tK,publish_option:o.Gq,message:o.tK,stream_id:o.tK,stream_sid:o.Tr,room_id:o.tK,video_en_codec_id:o.Tr,cap_w:o.Tr,cap_h:o.Tr,w:o.Tr,h:o.Tr,video_en_fps:o.Tr,video_en_bps:o.Tr,audio_c_channel_count:o.Tr,audio_en_bps:o.Tr,aec_level:o.Tr,ans_level:o.Tr,agc:o.yS,enable_camera:o.yS,enable_mic:o.yS,video_activate:o.yS,audio_activate:o.yS,gw_version:o.Tr,use_na:o.Tr,is_dual_stream:o.Tr},i={event:"/sdk/publish_target",error:{ee:t.ZEp,re:t.xU2,ne:t.S4u,te:t.I7C,oe:t.HO9,se:t.aUw,ie:t.Oy0}},u={event:"/mss/pushadd",error:{ee:t.ZEp},stream_id:o.tK,url:o.tK},c={event:"/mss/pushdel",error:{ee:t.ZEp},stream_id:o.tK,url:o.tK}},5095:function(e,r,n){n.d(r,{Gq:function(){return t},Tr:function(){return i},tK:function(){return o},yS:function(){return u},yp:function(){return s}});var t=function(e){return e},o=function(e){return e},s=function(e){return e},i=function(e){return e},u=function(e){return e}},8627:function(e,r,n){n.d(r,{$wo:function(){return M},Arx:function(){return be},B3d:function(){return le},Be2:function(){return G},FB3:function(){return F},HCP:function(){return Z},HO9:function(){return b},I4J:function(){return qe},I7C:function(){return V},J79:function(){return c},JDv:function(){return re},JSm:function(){return ee},L8E:function(){return R},LLz:function(){return E},MK1:function(){return ue},MrD:function(){return K},MuX:function(){return je},NCg:function(){return Ce},OdW:function(){return Pe},OrZ:function(){return y},Oy0:function(){return m},PA0:function(){return a},PTE:function(){return w},Q3v:function(){return ne},Q9p:function(){return l},RBR:function(){return oe},RZs:function(){return Oe},RfS:function(){return L},S4u:function(){return s},S5f:function(){return f},SB8:function(){return ge},SRE:function(){return U},SmZ:function(){return P},Tij:function(){return ke},VU9:function(){return S},WP4:function(){return $},XHx:function(){return _e},Xxx:function(){return z},YDn:function(){return me},ZEp:function(){return d},ZpF:function(){return q},Zws:function(){return he},_68:function(){return C},_HD:function(){return h},a$$:function(){return xe},aUw:function(){return k},aa2:function(){return T},ann:function(){return ie},b1q:function(){return ye},ckD:function(){return Se},clM:function(){return i},d49:function(){return u},dXc:function(){return we},dg1:function(){return D},dqB:function(){return ce},ekj:function(){return pe},f43:function(){return J},fzq:function(){return B},g9p:function(){return _},gHA:function(){return ae},gSF:function(){return p},hje:function(){return de},iei:function(){return x},jZ$:function(){return N},kOd:function(){return A},kbF:function(){return W},lgu:function(){return ve},m6U:function(){return Q},mrK:function(){return X},pWJ:function(){return Ee},qvY:function(){return te},rBJ:function(){return De},sVF:function(){return g},s_m:function(){return j},t85:function(){return I},wxm:function(){return fe},xU2:function(){return H},xbZ:function(){return se},xfZ:function(){return v},yK:function(){return O},zML:function(){return ze},zs3:function(){return Y}});var t=n(8866),o="the user cancels the stream request.",s={code:1000002,message:"not login room"},i={code:1000014,message:"stream ID is too long"},u={code:1000015,message:"streamID is empty"},c={code:1000016,message:"stream ID contains illegal characters"},a={code:1000017,message:t.Rl},f={code:1000018,message:t.qC},d={code:1100001,message:t.dO},l={code:1100002,message:"network timeout."},m={code:1100999,message:"unknown server error"},h={code:1101005,message:"signal hb fail"},g={code:1002014,msg:t.fT},p={code:1102017,message:"dispatch error"},_={code:1102018,message:"token expired"},b={code:1102021,message:"biz channel error."},v={code:1102022,message:"dispatch request timeout"},k={code:1102024,message:"invalid channel"},z={code:1003025,message:"stream is forbided by media server"},w={code:1003050,message:"extra info of publishing stream is null"},E={code:1103001,message:t.dO},y={code:1103002,message:"browser do not support"},O={code:1103010,message:"screen fail"},j={code:1103011,message:"enumerate devices fail"},q={code:1103021,message:"session request fail"},P={code:1103022,message:"create offer error"},S={code:1103023,message:"setLocalDescription error"},D={code:1103024,message:"mediaDesc error"},x={code:1103025,message:"other side offer error"},C={code:1103026,message:"candidate error"},N={code:1103027,message:"server session closed"},T={code:1103028,message:"ice connection error"},M={code:1103030,message:"negotiation timeout"},I={code:1103042,message:"screen canceled"},R={code:1103043,message:"screen not support"},B={code:1103044,message:t.aw},J={code:1103099,message:"stream is not capturing"},L={code:1103049,message:"repeated pull same stream"},Z={code:1103050,message:"websocket disconnected"},U={code:1103051,message:"publisher retry timeout"},F={code:1103053,message:"https is required"},H={code:1103055,message:t.Wk},W={code:1103056,message:"publish is publishing"},A={code:1103058,message:"client ip changed"},$={code:1103059,message:"ttl over time"},K={code:1103060,message:"session request timeout"},X={code:1103061,message:"get media fail"},Q={code:1103062,message:"update stream info fail"},V={code:1103063,message:"publish target no response"},Y={code:1103064,message:"get device not allowed"},G={code:1103065,message:"device is not readable"},ee={code:1103066,message:"device does not meet constraints"},re={code:1103067,message:"update sdp time out"},ne={code:1103068,message:"update sdp fail"},te={code:1103073,message:"video effect is starting, please operate after video effect is started"},oe={code:1103078,message:"publish stream poor and net probe poor"},se={code:1103089,message:o},ie={code:1104001,message:"input parm error"},ue={code:1104021,message:"session request fail"},ce={code:1104022,message:"create offer error"},ae={code:1104023,message:"setLocalDescription error"},fe={code:1104024,message:"mediaDesc error"},de={code:1104025,message:"other side offer error"},le={code:1104026,message:"candidate error"},me={code:1104027,message:"server session closed"},he={code:1104028,message:"ice connection error"},ge={code:1104029,message:"websocket disconnected"},pe={code:1104030,message:"negotiation timeout"},_e={code:1104031,message:"player retry timeout"},be={code:1104032,message:"player is playing"},ve={code:1104033,message:"client ip changed"},ke={code:1104034,message:"ttl is over time"},ze={code:1104035,message:"reset session push"},we={code:1104036,message:"session request timeout"},Ee={code:1104037,message:"probe time out"},ye={code:1104038,message:"resource mode is not supported"},Oe={code:1104039,message:"play stream not found"},je={code:1104041,message:"stream quality poor and net probe poor"},qe={code:1104042,message:o},Pe={code:1104043,message:"mini sdp error"},Se={code:1104045,message:"play streams is out limit"},De={code:1103052,message:"publisher cdn push error"},xe={code:1000055,message:"cdn url is invalid"},Ce={code:1103100,message:"background process is start, but not subscribe yet"}},8866:function(e,r,n){n.d(r,{Rl:function(){return l},Wk:function(){return d},aw:function(){return u},dO:function(){return c},fT:function(){return s},h2:function(){return f},l3:function(){return t},pt:function(){return i},qC:function(){return a},rV:function(){return o}});n(8627),n(6994);var t=Promise;function o(e,r){return Math.floor(Math.random()*(r-e+1))+e}var s="room not exist",i="device is not found",u="stream is not from zego",c="input param error",a="local stream wrong",f="no preview",d="publish stream no found",l="network is broken"},4872:function(e,r,n){function t(e){return"string"==typeof e}n.d(r,{QP:function(){return t}})},5960:function(e,r,n){var t,o=n(3788),s=o.Reader,i=o.Writer,u=o.util,c=o.roots.default||(o.roots.default={});c.proto_media=((t={}).MediaServerCommonResponse=function(){function e(e){if(e)for(var r=Object.keys(e),n=0;n<r.length;++n)null!=e[r[n]]&&(this[r[n]]=e[r[n]])}return e.prototype.code=0,e.prototype.message="",e.create=function(r){return new e(r)},e.encode=function(e,r){return r||(r=i.create()),null!=e.code&&Object.hasOwnProperty.call(e,"code")&&r.uint32(8).uint32(e.code),null!=e.message&&Object.hasOwnProperty.call(e,"message")&&r.uint32(18).string(e.message),r},e.decode=function(e,r){e instanceof s||(e=s.create(e));for(var n=void 0===r?e.len:e.pos+r,t=new c.proto_media.MediaServerCommonResponse;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:t.code=e.uint32();break;case 2:t.message=e.string();break;default:e.skipType(7&o)}}return t},e}(),t.RelayPublishCdnRequest=function(){function e(e){if(e)for(var r=Object.keys(e),n=0;n<r.length;++n)null!=e[r[n]]&&(this[r[n]]=e[r[n]])}return e.prototype.request_seq=0,e.prototype.request_cmd=0,e.prototype.streamid="",e.prototype.cdn_server="",e.prototype.publish_timeout=0,e.prototype.request_seq_v2=u.Long?u.Long.fromBits(0,0,!0):0,e.create=function(r){return new e(r)},e.encode=function(e,r){return r||(r=i.create()),null!=e.request_seq&&Object.hasOwnProperty.call(e,"request_seq")&&r.uint32(8).uint32(e.request_seq),null!=e.request_cmd&&Object.hasOwnProperty.call(e,"request_cmd")&&r.uint32(16).int32(e.request_cmd),null!=e.streamid&&Object.hasOwnProperty.call(e,"streamid")&&r.uint32(26).string(e.streamid),null!=e.cdn_server&&Object.hasOwnProperty.call(e,"cdn_server")&&r.uint32(34).string(e.cdn_server),null!=e.publish_timeout&&Object.hasOwnProperty.call(e,"publish_timeout")&&r.uint32(40).uint32(e.publish_timeout),null!=e.request_seq_v2&&Object.hasOwnProperty.call(e,"request_seq_v2")&&r.uint32(48).uint64(e.request_seq_v2),r},e.decode=function(e,r){e instanceof s||(e=s.create(e));for(var n=void 0===r?e.len:e.pos+r,t=new c.proto_media.RelayPublishCdnRequest;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:t.request_seq=e.uint32();break;case 2:t.request_cmd=e.int32();break;case 3:t.streamid=e.string();break;case 4:t.cdn_server=e.string();break;case 5:t.publish_timeout=e.uint32();break;case 6:t.request_seq_v2=e.uint64();break;default:e.skipType(7&o)}}return t},e}(),t.RelayPublishCdnResponse=function(){function e(e){if(e)for(var r=Object.keys(e),n=0;n<r.length;++n)null!=e[r[n]]&&(this[r[n]]=e[r[n]])}return e.prototype.request_seq=0,e.prototype.response=null,e.prototype.request_seq_v2=u.Long?u.Long.fromBits(0,0,!0):0,e.create=function(r){return new e(r)},e.encode=function(e,r){return r||(r=i.create()),null!=e.request_seq&&Object.hasOwnProperty.call(e,"request_seq")&&r.uint32(8).uint32(e.request_seq),null!=e.response&&Object.hasOwnProperty.call(e,"response")&&c.proto_media.MediaServerCommonResponse.encode(e.response,r.uint32(18).fork()).ldelim(),null!=e.request_seq_v2&&Object.hasOwnProperty.call(e,"request_seq_v2")&&r.uint32(24).uint64(e.request_seq_v2),r},e.decode=function(e,r){e instanceof s||(e=s.create(e));for(var n=void 0===r?e.len:e.pos+r,t=new c.proto_media.RelayPublishCdnResponse;e.pos<n;){var o=e.uint32();switch(o>>>3){case 1:t.request_seq=e.uint32();break;case 2:t.response=c.proto_media.MediaServerCommonResponse.decode(e,e.uint32());break;case 3:t.request_seq_v2=e.uint64();break;default:e.skipType(7&o)}}return t},e}(),t),e.exports=c},6994:function(r){r.exports=e},3788:function(e){e.exports=r}},t={};function o(e){var r=t[e];if(void 0!==r)return r.exports;var s=t[e]={exports:{}};return n[e](s,s.exports,o),s.exports}o.d=function(e,r){for(var n in r)o.o(r,n)&&!o.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return function(){o.r(s),o.d(s,{StreamCDN:function(){return v}});var e,r,n,t,i=o(8627),u=o(4908),c=o(4872),a=o(1290),f=o(8866),d=function(){function e(e,r){this.ue=e,this.ce=r,this.attempt=0,this.ae=.3,this.fe=4.8,this.de=0,this.retryTimer=null,this.maxTimer=null,this.isOverTime=!1,this.RETRY_MAX_TIME=60}return e.prototype.setRetryRule=function(e){switch(this.de=e,e){case 1:this.ae=.3,this.fe=32;break;case 0:this.ae=.3,this.fe=4.8}},e.prototype.getRetryDelayByCount=function(e){var r;r=1===this.de?e+2:e<2?0:e;var n=Math.min(this.fe,this.ae*Math.pow(2,r)),t=(0,f.rV)(0,1e3*n);return this.ue.info("".concat(a.RnN," ").concat(this.attempt," ").concat(n," ").concat(t)),t},e.prototype.initCallback=function(e,r){this.sucCallBack=e,this.failCallBack=r},e.prototype.startMaxTime=function(){var e,r=this;this.ue.info("".concat(a.zUi," ").concat(null===(e=this.requestInfo)||void 0===e?void 0:e.streamID," call")),this.maxTimer?this.ue.warn("".concat(a.zUi," max timer")):(this.maxTimer=setTimeout((function(){var e;r.ue.warn("".concat(a.zUi," ").concat(null===(e=r.requestInfo)||void 0===e?void 0:e.streamID," over max time ").concat(r.RETRY_MAX_TIME,"s, stop retry")),r.isOverTime=!0,r.requestFail(r._err)}),1e3*this.RETRY_MAX_TIME),this.ue.info("".concat(a.zUi," maxTimer=").concat(this.maxTimer)))},e.prototype.invalid=function(){this.clearRetryTimer(),this.attempt=0},e.prototype.clearRetryTimer=function(){this.retryTimer&&(clearTimeout(this.retryTimer),this.retryTimer=null)},e.prototype.requestFail=function(e){this.invalid(),this.stopMaxTime(),this.failCallBack&&(this.failCallBack(e),this.resetCallback())},e.prototype.stopMaxTime=function(){this.ue.info("".concat(a.zub," stop max timer")),this.maxTimer&&clearTimeout(this.maxTimer),this.maxTimer=null},e.prototype.resetCallback=function(){this.sucCallBack=void 0,this.failCallBack=void 0},e}(),l=(e=function(r,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])},e(r,n)},function(r,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function t(){this.constructor=r}e(r,n),r.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}),m=function(e){function r(r,n,t){var o=e.call(this,r,n)||this;return o.ue=r,o.ce=n,o.le=t,o.RETRY_MAX_TIME=8,o}return l(r,e),r.prototype.initReqParams=function(e,r){this.streamId=e,this.cdnPushConfig=r},r.prototype.active=function(e){var r=this;if(void 0===e&&(e=!1),this.retryTimer)this.ue.warn("".concat(a.v$W," was actived, ignore"));else if(this.isOverTime)this.ue.warn("".concat(a.v$W," retry over time, stop retry"));else{var n=function(){r.clearRetryTimer(),r.le.sendCDNRequest(r.streamId,r.cdnPushConfig,(function(e,n){var t=e.body;r.invalid(),r.stopMaxTime(),r.sucCallBack&&(r.sucCallBack&&r.sucCallBack(t,n),r.resetCallback())}),(function(e){r._err=e;var n=e.status_code;r.isOverTime?r.requestFail(e):((429===n||n>=500&&n<600)&&r.setRetryRule(1),r.active())})),e||r.attempt++};if(e)n();else{var t=this.getRetryDelayByCount(this.attempt);this.retryTimer=setTimeout(n,t)}}},r}(d);r=o(5960).proto_media,n=o(3788),t=o(6994),n.util.Long=t,n.configure();var h,g=function(){function e(){}return e.prototype.encodeRelayPublishCdnReq=function(e){var n=r.RelayPublishCdnRequest.create(e);return r.RelayPublishCdnRequest.encode(n).finish()},e.prototype.decodeRelayPublishCdnRsp=function(e){var n=r.RelayPublishCdnResponse.decode(e);return n.request_seq_v2&&t.isLong(n.request_seq_v2)&&(n.request_seq_v2=n.request_seq_v2.toNumber()),n},e}();!function(e){e[e.I=0]="I",e[e.H=10]="H",e[e.M=100]="M",e[e.L=1e3]="L"}(h||(h={}));var p={},_={_sendCDNPublishByAccessHub:function(e,r,n,t){var o=this;this.mediaProtoBuf||(this.mediaProtoBuf=new g);var s=new m(this.logger,this.stateCenter,this);s.initReqParams(e,r);var a=function(e,r){try{var n=o.mediaProtoBuf.decodeRelayPublishCdnRsp(e);o.logger.info("zb.sh.pt rsp decode ".concat(JSON.stringify(n)));var t=(null==n?void 0:n.response)||{};return{code:t.code,msg:t.message}}catch(e){return{code:-1}}};s.initCallback((function(e,s){var u=a(e),c=u.code,f=u.msg;c&&0!=c?(o.logger.error("zb.sh.pt "+r.type+" error code: "+c+" "+f),t(5004===c?i.a$$:i.Oy0," cmd: ".concat(r.type," ").concat(c," ").concat(f))):(o.logger.info("zb.sh.pt "+r.type+" success"),n&&n({errorCode:0,extendedData:""}))}),(function(e){var n=e.status_code,s=e.body,i=e.code,f=e.msg,d=JSON.parse(JSON.stringify(u.Of.error.ie)),l="";if(i)d={code:i,msg:f},l=f;else if(200===n)o.logger.info("zb.sh.pt error: "),d=u.Of.error.ie,l="cmd: ".concat(r.type);else{var m="";if((0,c.QP)(s))m=s;else{var h=a(s);m=h.code+" "+h.msg}l="request media server fail, error: "+n+" "+m}o.logger.error("zb.sh.pt "+l),t&&t(d,l)})),s.startMaxTime(),s.active(!0)},sendCDNRequest:function(e,r,n,t){var o=this,s="addpush"===r.type?1:2,i={request_seq:this.stateCenter.cdnSeq++,request_cmd:s,streamid:e,cdn_server:r.pushUrl,request_seq_v2:this.stateCenter.cdnSeqV2++};this.logger.info("zb.sh.scpba "+JSON.stringify(i));var u=this.mediaProtoBuf.encodeRelayPublishCdnReq(i);this.sendHttpPBRequest({interfaceID:6,resID:this.stateCenter.appid+"/"+e},u,(function(e,r){o.logger.info("zb.sh.pt receive message "+(null==e?void 0:e.status_code)),n&&n(e,r)}),(function(e){t&&t(e)}),{timeout:4e3})},_publishTarget:function(e,r,n){this.logger.info("zb.sh.pt call");var t=e.streamID;this.stateCenter.testEnvironment&&(t="zegotest-"+this.stateCenter.appid+"-"+e.streamID),this._sendCDNPublishByAccessHub(t,e,r,n)}},b=function(){function e(e,r,n,t){this.ue=e,this.dataReport=r,this.me=n,this.ce=t,this.screenShotReady=!1}return Object.defineProperty(e.prototype,"he",{get:function(){return this.ce.reporter},enumerable:!1,configurable:!0}),e.prototype.publishTarget=function(e){var r=this,n="";switch(e.type){case"addpush":n=u.iJ.event;break;case"delpush":case"clearpush":n=u.ns.event}var t=this.he.createSpan(h.H,{key:u.pO.event,par:e.streamID},{key:""},n);return t.setAttributes({url:u.ns.url(e.pushUrl)}),new f.l3((function(n,o){var s=function(e,n){r.ue.error("zb.pt "+(n||e.message)),r.he.setError(t,e,n),o({errorCode:e.code,extendedData:e.message+(n?" "+n:"")})};if(-1==["addpush","delpush","clearpush"].indexOf(e.type))return r.ue.error("zb.sh.pt cdn push type error"),void s(i.rBJ,"type error");if(e.streamID&&(0,c.QP)(e.streamID))if(e.pushUrl&&(0,c.QP)(e.pushUrl))if(r.ce.publishStreamList[e.streamID]){var a=r.me.getRoomByStreamID(e.streamID);if(a){a.streamHandler._publishTarget(e,(function(e){t.end(),n(e)}),s)}else s(u.Of.error.ne)}else s(u.Of.error.re);else s(u.Of.error.ee,"push url error");else s(u.Of.error.ee,"stream id type error")}))},e}(),v={type:"StreamCDN",install:function(e,r,n){for(var t in Object.defineProperty(r.prototype,"initStreamCDN",{value:function(){this.streamCDNModule=new b(this.logger,this.dataReport,this.streamCenter,this.stateCenter)},writable:!1}),p)Object.defineProperty(e.prototype,t,{value:p[t],writable:!1});for(var t in _)Object.defineProperty(n.prototype,t,{value:_[t],writable:!1})}}}(),s}()}));