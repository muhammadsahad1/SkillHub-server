!function(t,i){if("object"==typeof exports&&"object"==typeof module)module.exports=i(require("long"));else if("function"==typeof define&&define.amd)define(["long"],i);else{var n="object"==typeof exports?i(require("long")):i(t.long);for(var r in n)("object"==typeof exports?exports:t)[r]=n[r]}}("undefined"!=typeof self?self:this,(function(t){return function(){"use strict";var i={6994:function(i){i.exports=t}},n={};function r(t){var o=n[t];if(void 0!==o)return o.exports;var e=n[t]={exports:{}};return i[t](e,e.exports,r),e.exports}r.d=function(t,i){for(var n in i)r.o(i,n)&&!r.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:i[n]})},r.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};return function(){function t(t){return"number"==typeof t}function i(t){return void 0===t}function n(t){return null!==t&&t instanceof Object}function e(t){return t instanceof MediaStream}function u(t){return t instanceof HTMLVideoElement}function s(t){return t instanceof HTMLImageElement}r.r(o),r.d(o,{StreamCompositor:function(){return M}});var c={code:1100001,message:m},a={code:1103074,message:"video track is not readable"},f={code:1103076,message:"audio track is not readable"},h={code:1103077,message:"compositor blur not support."},v=(r(6994),Promise),l=document;var d="stream is not from zego",m="input param error";var p,w=function(){function t(t,i,n){this.t=t,this.i=i,this.u=n,this.fps=15,this.outputBitrate=1500,this.hasPortrait=!1,this.isClear=!1,this.canvasEl=l.createElement("canvas"),this.ctx=this.canvasEl.getContext("2d")}return t.prototype.setVideoConfig=function(t){var i=t.height,n=t.frameRate,r=t.bitrate;this.canvasEl.width=t.width,this.canvasEl.height=i,n&&(this.fps=n),r&&(this.outputBitrate=r)},t.prototype.setInputsOption=function(t){var i=this;this.isClear=!0,this.layers=t.filter((function(t){var i=t.stream,n=t.option,r=s(t.source),o=void 0!==n.contentType&&["ALL","VIDEO"].includes(n.contentType),e=!n.contentType||o,u=i&&i.getVideoTracks();if(0==(null==u?void 0:u.length)&&o)throw a;return r||e&&u&&(null==u?void 0:u.length)>0})).map((function(t){var n,r=t.source,o=t.stream,e=t.option;if(o&&"safari"===i.i.browser){var u=i.u.checkPreview(o);u.backgroundProcessor?(n=u.backgroundProcessor.getCanvas(),i.bgProcessor=u.backgroundProcessor,i.hasPortrait=!0):i.hasPortrait=!1}return{source:r,option:e,canvas:n}})),this.layers.sort((function(t,i){var n,r;return void 0!==(null===(n=t.option.layout)||void 0===n?void 0:n.zOrder)&&void 0!==(null===(r=i.option.layout)||void 0===r?void 0:r.zOrder)?t.option.layout.zOrder-i.option.layout.zOrder:-1}))},t.prototype.checkVideoInputs=function(t){var i=!0;return t.forEach((function(t){var n=t.stream,r=t.option,o=void 0!==r.contentType&&["ALL","VIDEO"].includes(r.contentType),e=n&&n.getVideoTracks();0==(null==e?void 0:e.length)&&o&&(i=!1)})),i},t.prototype.generateVideoTrack=function(){var t,i=this;if(this.hasPortrait?null===(t=this.bgProcessor)||void 0===t||t.setDrawBack((function(){i.draw()})):this.intervalId||(this.intervalId=setInterval((function(){i.draw()}),1e3/this.fps)),!this.canvasTrack){var n=this.canvasEl.captureStream(this.fps);this.canvasTrack=n.getVideoTracks()[0]}return this.canvasTrack},t.prototype.stopOutputStream=function(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.layers.forEach((function(t){t.source&&u(t.source)&&(t.source.pause(),t.source.remove(),t.source.srcObject=null,t.source=null)})),this.u.trackUtils.stopTrack(this.canvasTrack),this.canvasTrack=null,this.ctx=null,this.layers=[]},t.prototype.draw=function(){var t,i;if(this.ctx){this.ctx.clearRect(0,0,this.canvasEl.width,this.canvasEl.height);for(var n=0;n<this.layers.length;n++){var r=this.layers[n],o=r.source,e=r.option,c=r.canvas;if(e.layout){var a=e.layout,f=a.x,h=a.y,v=a.width,l=a.height,d=u(o)?o.videoWidth:s(o)?o.naturalWidth:0,m=u(o)?o.videoHeight:s(o)?o.naturalHeight:0;if(0==d||0==m)continue;var p=c||o;switch(e.objectFit){case"contain":if(v/l<=d/m){var w=(l-(b=v*m/d))/2;null===(t=this.ctx)||void 0===t||t.drawImage(p,f,h+w,v,b)}else{w=(v-(y=l*d/m))/2;null===(i=this.ctx)||void 0===i||i.drawImage(p,f+w,h,y,l)}break;case"cover":var y,b;if(v/l<=d/m)this.ctx.drawImage(p,(d-(y=v*m/l))/2,0,y,m,f,h,v,l);else this.ctx.drawImage(p,0,(m-(b=d*l/v))/2,d,b,f,h,v,l);break;case"fill":this.ctx.drawImage(p,f,h,v,l)}}}}},t}(),y=function(){function i(t,i,n){this.t=t,this.ac=i,this.u=n,this.inputs=[],this.descNode=this.ac.createMediaStreamDestination()}return i.prototype.setInputsOption=function(i){var n=this;this.inputs=i.filter((function(t){var i=t.stream,r=t.option,o=i&&i.getAudioTracks(),e=n.u.checkPreview(i),u=void 0!==r.contentType&&["ALL","AUDIO"].includes(r.contentType);if((0==(null==o?void 0:o.length)||(null==e?void 0:e.hasEmptyAudioTrack))&&u)throw f;return o&&(null==o?void 0:o.length)>0})),this.inputs.forEach((function(i){var n,r,o=i.audioNodes,e=i.option;(void 0===i.option.volume&&(i.option.volume=100),o)&&(!e.contentType||["ALL","AUDIO"].includes(e.contentType)?(!o.hasAudio&&(null===(n=null==o?void 0:o.srcNode)||void 0===n||n.connect(o.volumeNode)),o.hasAudio=!0,t(i.option.volume)&&(o.volumeNode.gain.value=i.option.volume/100)):(null===(r=null==o?void 0:o.srcNode)||void 0===r||r.disconnect(o.volumeNode),o.hasAudio=!1))}))},i.prototype.checkAudioInputs=function(t){var i=this,n=!0;return t.forEach((function(t){var r=t.stream,o=t.option,e=r&&r.getAudioTracks(),u=i.u.checkPreview(r),s=void 0!==o.contentType&&["ALL","AUDIO"].includes(o.contentType);(0==(null==e?void 0:e.length)||(null==u?void 0:u.hasEmptyAudioTrack))&&s&&(n=!1)})),n},i.prototype.generateAudioTrack=function(){for(var t,i=0;i<this.inputs.length;i++){var n=this.inputs[i],r=n.stream,o=n.option,e=!o.contentType||["ALL","AUDIO"].includes(o.contentType),u=this.createAudioNode(r,n.option.volume),s=u.srcNode,c=u.volumeNode;e&&(null==s||s.connect(c)),n.audioNodes={srcNode:s,volumeNode:c,hasAudio:e}}var a=null===(t=this.descNode)||void 0===t?void 0:t.stream.getAudioTracks();return a&&a.length>0?a[0]:(this.ac.resume(),null)},i.prototype.createAudioNode=function(t,i){var n=this.ac.createMediaStreamSource(t),r=this.ac.createGain();return r.gain.value=i/100,r.connect(this.descNode),{srcNode:n,volumeNode:r}},i.prototype.stopAudioCompositor=function(){for(var t=0;t<this.inputs.length;t++){var i=this.inputs[t],n=i.audioNodes,r=i.option;if(n){var o=n.srcNode,e=n.volumeNode;(!r.contentType||["ALL","AUDIO"].includes(r.contentType))&&(null==o||o.disconnect(e),null==e||e.disconnect(this.descNode)),n.volumeNode=null,n.srcNode=null}this.descNode=null}this.inputs=[]},i.prototype.replaceSource=function(t){var i=this;this.inputs.forEach((function(n){var r=n.stream,o=n.audioNodes;if(t===r&&o){var e=o.srcNode,u=o.volumeNode,s=o.hasAudio,c=i.ac.createMediaStreamSource(r);s&&(null==e||e.disconnect(u),c.connect(u)),o.srcNode=c}}))},i}();!function(t){t.STREAM_COMPOSITOR_MODULE="zc.scm.0"}(p||(p={}));var b=function(t){return t},g=function(t){return t},L={event:"/sdk/create_stream_zgp_compositor"},O={event:"/sdk/start_compositing_stream",error:{},media_stream_id:g,compose_stream_conf:b};var E="/sdk/init",_=E;function k(){return navigator.userAgent||""}var A,j=function(){return j=Object.assign||function(t){for(var i,n=1,r=arguments.length;n<r;n++)for(var o in i=arguments[n])Object.prototype.hasOwnProperty.call(i,o)&&(t[o]=i[o]);return t},j.apply(this,arguments)},I=function(t,i,n,r){return new(n||(n=Promise))((function(o,e){function u(t){try{c(r.next(t))}catch(t){e(t)}}function s(t){try{c(r.throw(t))}catch(t){e(t)}}function c(t){var i;t.done?o(t.value):(i=t.value,i instanceof n?i:new n((function(t){t(i)}))).then(u,s)}c((r=r.apply(t,i||[])).next())}))},D=function(t,i){var n,r,o,e,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;e&&(e=0,s[0]&&(u=0)),u;)try{if(n=1,r&&(o=2&s[0]?r.return:s[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,s[1])).done)return o;switch(r=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return u.label++,{value:s[1],done:!1};case 5:u.label++,r=s[1],s=[0];continue;case 7:s=u.ops.pop(),u.trys.pop();continue;default:if(!(o=u.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){u=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){u.label=s[1];break}if(6===s[0]&&u.label<o[1]){u.label=o[1],o=s;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(s);break}o[2]&&u.ops.pop(),u.trys.pop();continue}s=i.call(t,u)}catch(t){s=[6,t],r=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},S=function(){function r(t,i,n,r){this.t=t,this.i=i,this.u=n,this.ac=r,this.mixOutputConfig={width:0,height:0,frameRate:15,bitrate:2500},this.inputStreamOptions=[],this.fit="cover",this.videoCompositor=new w(t,i,n),this.audioCompositor=new y(t,r,n)}return r.prototype.setOutputConfig=function(n){var r=n.height,o=n.frameRate,e=n.bitrate;if(!t(n.width))throw Error("param width error");if(!t(r))throw Error("param height error");if(!i(o)&&!t(o))throw Error("param frameRate error");if(!i(e)&&!t(e))throw Error("param bitrate error");this.mixOutputConfig=j(j({},this.mixOutputConfig),n),this.videoCompositor.setVideoConfig(this.mixOutputConfig)},r.prototype.setInputEndpoint=function(t,i){return I(this,void 0,void 0,(function(){var n,r,o;return D(this,(function(u){switch(u.label){case 0:if(n=function(t,i){if(t&&!e(t)&&t.zegoStream){if(i.info("cu.gs type:zego"),e(t.stream))return t.stream;throw new Error("The ZegoLocalStream type requires first calling the capture api to capture the stream")}return t}(t,this.t),!this.checkStreamIsLocal(n))throw Error(d);return r=this.inputStreamOptions.find((function(t){return t.stream===n})),this.checkInputOption(i,!!r),r?(r.option=this.assignObj(r.option,i),[3,3]):[3,1];case 1:return[4,this.createVideo(n)];case 2:o=u.sent(),this.addInputLayer({source:o,stream:n,option:j({objectFit:this.fit},i)}),u.label=3;case 3:if(!this.videoCompositor.checkVideoInputs(this.inputStreamOptions))throw a;if(!this.audioCompositor.checkAudioInputs(this.inputStreamOptions))throw f;return this.videoCompositor.setInputsOption(this.inputStreamOptions),this.audioCompositor.setInputsOption(this.inputStreamOptions),[2]}}))}))},r.prototype.addImage=function(t,i){this.checkImg(t);var n=this.inputStreamOptions.find((function(i){return i.source===t}));this.checkInputOption(i,!!n),n?n.option=this.assignObj(n.option,i):this.addInputLayer({source:t,option:j({objectFit:this.fit},i)}),this.videoCompositor.setInputsOption(this.inputStreamOptions)},r.prototype.removeImage=function(t){this.checkImg(t);var i=this.inputStreamOptions.findIndex((function(i){return i.source===t}));i>0&&(this.inputStreamOptions.splice(i,1),this.videoCompositor.setInputsOption(this.inputStreamOptions))},r.prototype.startComposingStream=function(){var t=this;return new v((function(i,n){if(!t.checkOutputs())return t.t.error("zc.sc.scs.0 output config error"),void n(c);if(!t.checkInputs())return t.t.error("zc.sc.scs.0 input params error"),void n(c);if(!t.checkBrowserSupport())return t.t.error("zc.sc.scs.0 browser not support compositor"),void n(h);t.videoCompositor.setInputsOption(t.inputStreamOptions);var r=t.videoCompositor.generateVideoTrack();t.audioCompositor.setInputsOption(t.inputStreamOptions);var o=t.audioCompositor.generateAudioTrack();t.uploadEvent();var e=[r];o&&e.push(o);var u=new MediaStream(e);t.outputStream=u,t.u.createCompositingPreviewer(u,t.mixOutputConfig,t.inputStreamOptions),i(u)}))},r.prototype.stopComposingStream=function(){var t=this;return new v((function(i){var n,r;if(t.outputStream){var o=t.u.checkPreview(t.outputStream);o&&(null===(n=o.rtcViewer)||void 0===n||n.destroy(),o.streamCompositor=null,t.u.removePreview(o)),null===(r=t.outputStream)||void 0===r||r.getTracks().forEach((function(i){t.u.trackUtils.stopTrack(i)}))}try{t.videoCompositor.stopOutputStream(),t.audioCompositor.stopAudioCompositor()}catch(t){i(!1)}t.inputStreamOptions=[],i(!0)}))},r.prototype.checkInputs=function(){var t=this.mixOutputConfig,i=t.width,n=t.height;return this.inputStreamOptions.every((function(t){var r=t.option.layout;return r.x<=i&&r.y<=n&&r.x+r.width<=i&&r.y+r.height<=n&&r.width<=i&&r.height<=n}))},r.prototype.checkOutputs=function(){var t=this.mixOutputConfig;return t.width>0&&t.height>0&&t.frameRate>0&&t.bitrate>0},r.prototype.uploadEvent=function(){var t=this.i.reporter.createSpan(A.H,{key:_},{key:""},O.event),i=this.inputStreamOptions.map((function(t){var i=t.option,n=i.layout,r=i.objectFit,o=i.contentType;return{content_control:"AUDIO"===o?1:"VIDEO"===o?2:0,x:n.x,y:n.y,w:n.width,h:n.height,order:n.zOrder,render_mode:"cover"===r?0:"contain"===r?1:2}})),n=this.mixOutputConfig;t.setAttributes({compose_stream_conf:O.compose_stream_conf({fps:n.frameRate,bitrate:n.bitrate,w:n.width,h:n.height,stream_cnt:i.length,input_stream_list:i})}),t.end()},r.prototype.checkImg=function(t){if(!t||!s(t)||!t.naturalWidth)throw this.t.error(p.STREAM_COMPOSITOR_MODULE+" source must be image and loaded"),Error("source must be image and loaded")},r.prototype.checkInputOption=function(t,r){var o=this,e=t.layout,u=t.objectFit,s=t.contentType;if(!i(e)){if(!n(e))throw Error("param layout error");["x","y","width","height"].forEach((function(t){o.checkNumParam(e,t,r)})),this.checkOptionalNumOptParam(e,"zOrder")}if(!i(u)&&!["cover","contain","fill"].includes(u))throw Error("param objectFit error");if(!i(s)&&!["ALL","VIDEO","AUDIO"].includes(s))throw Error("param contentType error");this.checkOptionalNumOptParam(t,"volume")},r.prototype.checkNumParam=function(i,n,r){if(r&&void 0===i[n]);else if(!t(i[n]))throw Error("param ".concat(n," error"))},r.prototype.checkOptionalNumOptParam=function(i,n){if(void 0!==i[n]&&!t(i[n]))throw Error("param ".concat(n," error"))},r.prototype.checkStreamIsLocal=function(t){var i=this.u.checkPreview(t),n=this.u.checkPlayer(t);return i&&(i.streamCompositor=this),!!i||!!n},r.prototype.addInputLayer=function(t){var i,n=t.option;void 0===(null===(i=n.layout)||void 0===i?void 0:i.zOrder)&&(n.layout.zOrder=0),this.inputStreamOptions.push(t)},r.prototype.createVideo=function(t){return I(this,void 0,void 0,(function(){var i=this;return D(this,(function(n){return[2,new v((function(n,r){return I(i,void 0,void 0,(function(){var i,o,e,u,s=this;return D(this,(function(c){return(i=l.createElement("video")).setAttribute("autoplay","autoplay"),i.setAttribute("muted","true"),i.muted=!0,i.setAttribute("playsinline","playsinline"),i.setAttribute("style","display:none"),o=null,e=function(){o&&(clearTimeout(o),o=null),i.play().catch((function(t){console.error(t)})),o=window.setTimeout((function(){s.t.warn("zc.sc.cv  video track error"),r(a)}),1e3)},u=function(){o&&clearTimeout(o),i&&i.removeEventListener("playing",u),n(i)},i&&i.addEventListener("playing",u),i.srcObject=t,i.play().catch((function(t){console.error(t)})),o=window.setTimeout((function(){e()}),1e3),[2]}))}))}))]}))}))},r.prototype.assignObj=function(t,i){void 0===t&&(t={});var r=t;if(!n(t)||!n(i))return i;for(var o in i)r[o]=t.hasOwnProperty(o)?this.assignObj(t[o],i[o]):i[o];return r},r.prototype.replaceSource=function(t){this.audioCompositor.replaceSource(t)},r.prototype.checkBrowserSupport=function(){var t=!0,i=function(){var t=k().toLowerCase().match(/cpu iphone os (.*?) like mac os/);return t&&t[1]||""}();return i&&i.includes("14_6")&&(t=!1),t},r}(),x=function(){function t(t){this.v=t}return t.prototype.addImage=function(t,i){this.v.addImage(t,i)},t.prototype.removeImage=function(t){this.v.removeImage(t)},t.prototype.setInputEndpoint=function(t,i){return this.v.setInputEndpoint(t,i)},t.prototype.setOutputConfig=function(t){this.v.setOutputConfig(t)},t.prototype.startComposingStream=function(){return this.v.startComposingStream()},t.prototype.stopComposingStream=function(){return this.v.stopComposingStream()},t}();!function(t){t[t.I=0]="I",t[t.H=10]="H",t[t.M=100]="M",t[t.L=1e3]="L"}(A||(A={}));var z={createStreamCompositor:function(){var t=this.reporter.createSpan(A.H,{key:_},{key:""},L.event),i=new S(this.logger,this.stateCenter,this.streamCenter,this.ac);return t.end(),new x(i)}},M={install:function(t){for(var i in z)Object.defineProperty(t.prototype,i,{value:z[i],writable:!1})},get type(){return"StreamCompositor"}}}(),o}()}));